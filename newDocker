#!/usr/bin/env bash

set -euo pipefail

# ---- resolve script directory ----
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_ENV="$SCRIPT_DIR/.env"

if [[ ! -f "$SCRIPT_ENV" ]]; then
  echo "Missing config file: $SCRIPT_ENV"
  exit 1
fi

# Load config
set -a
source "$SCRIPT_ENV"
set +a

# Required vars
: "${TEMPLATE_FOLDER:?}"
: "${SERVICE_NAME_PLACEHOLDER:?}"

DOCKER_COMPOSE_TEMPLATE="$TEMPLATE_FOLDER/docker-compose.yml"
ENV_TEMPLATE="$TEMPLATE_FOLDER/.env"
REMINDERS_TEMPLATE="$TEMPLATE_FOLDER/reminders.txt"

# Validate templates
for f in "$DOCKER_COMPOSE_TEMPLATE" "$ENV_TEMPLATE" "$REMINDERS_TEMPLATE"; do
  if [[ ! -f "$f" ]]; then
    echo "Missing template file: $f"
    exit 1
  fi
done

# ---- argument handling ----
TARGET_DIR="."
SERVICE_NAME=""

if [[ $# -gt 1 ]]; then
  echo "Usage: newDocker [service_name]"
  exit 1
fi

if [[ $# -eq 1 ]]; then
  SERVICE_NAME="$1"
  TARGET_DIR="$SERVICE_NAME"

  if [[ -e "$TARGET_DIR" ]]; then
    echo "Directory already exists: $TARGET_DIR"
    exit 1
  fi

  mkdir -p "$TARGET_DIR"
else
  SERVICE_NAME="$(basename "$PWD")"
fi

# ---- file creation ----
cp "$DOCKER_COMPOSE_TEMPLATE" "$TARGET_DIR/docker-compose.yml"
cp "$ENV_TEMPLATE" "$TARGET_DIR/.env"

# ---- service name replacement ----
sed -i.bak \
  "s/${SERVICE_NAME_PLACEHOLDER}/${SERVICE_NAME}/g" \
  "$TARGET_DIR/docker-compose.yml"
rm "$TARGET_DIR/docker-compose.yml.bak"

# ---- output reminders ----
echo
echo "========== REMINDERS =========="
cat "$TEMPLATE_FOLDER/reminders.txt"
echo "==============================="


